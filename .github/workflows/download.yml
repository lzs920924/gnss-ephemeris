name: Download GNSS Ephemeris

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download BRDC from CDDIS
      env:
        CDDIS_USER: ${{ secrets.CDDIS_USER }}
        CDDIS_PASS: ${{ secrets.CDDIS_PASS }}
      run: |
        YEAR=$(date -u +%Y)
        DOY=$(date -u +%j)
        
        mkdir -p data
        
        FILENAME="BRDC00IGS_R_${YEAR}${DOY}0000_01D_MN.rnx.gz"
        URL="https://cddis.nasa.gov/archive/gnss/data/daily/${YEAR}/brdc/${FILENAME}"
        
        echo "Downloading: $URL"
        curl -f -u "${CDDIS_USER}:${CDDIS_PASS}" -o "data/${FILENAME}" "$URL" || echo "Today not available"
        
        # 昨天的
        YESTERDAY=$(date -u -d "yesterday" +%j)
        YEAR_Y=$(date -u -d "yesterday" +%Y)
        FILENAME_Y="BRDC00IGS_R_${YEAR_Y}${YESTERDAY}0000_01D_MN.rnx.gz"
        URL_Y="https://cddis.nasa.gov/archive/gnss/data/daily/${YEAR_Y}/brdc/${FILENAME_Y}"
        
        curl -f -u "${CDDIS_USER}:${CDDIS_PASS}" -o "data/${FILENAME_Y}" "$URL_Y" || echo "Yesterday failed"
        
        ls -la data/
        
    - name: Commit and push
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add data/
        git diff --staged --quiet || git commit -m "Update $(date -u +%Y-%m-%d_%H:%M)"
        git push
